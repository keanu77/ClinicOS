generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS (Note: SQLite doesn't support enums, using String)
// ============================================

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  role         String   @default("STAFF") // STAFF, SUPERVISOR, ADMIN
  passwordHash String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  createdHandovers  Handover[]        @relation("CreatedHandovers")
  assignedHandovers Handover[]        @relation("AssignedHandovers")
  comments          HandoverComment[]
  shifts            Shift[]
  inventoryTxns     InventoryTxn[]
  auditLogs         AuditLog[]
  notifications     Notification[]

  @@index([email])
  @@index([role, isActive])
}

model Handover {
  id          String    @id @default(cuid())
  title       String
  content     String
  status      String    @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, CANCELLED
  priority    String    @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  dueDate     DateTime?

  createdById String
  createdBy   User      @relation("CreatedHandovers", fields: [createdById], references: [id], onDelete: Restrict)

  assigneeId  String?
  assignee    User?     @relation("AssignedHandovers", fields: [assigneeId], references: [id], onDelete: SetNull)

  shiftId     String?
  shift       Shift?    @relation(fields: [shiftId], references: [id], onDelete: SetNull)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  comments    HandoverComment[]

  @@index([createdById, status])
  @@index([assigneeId, status])
  @@index([status, priority, createdAt])
  @@index([shiftId])
  @@index([dueDate, status])
}

model HandoverComment {
  id         String   @id @default(cuid())
  content    String

  handoverId String
  handover   Handover @relation(fields: [handoverId], references: [id], onDelete: Cascade)

  authorId   String
  author     User     @relation(fields: [authorId], references: [id], onDelete: Restrict)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([handoverId, createdAt])
  @@index([authorId])
}

model Shift {
  id        String   @id @default(cuid())
  date      DateTime
  type      String   // MORNING, AFTERNOON, NIGHT

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  handovers Handover[]

  @@unique([date, type, userId])
  @@index([userId, date])
  @@index([date, type])
}

model InventoryItem {
  id           String    @id @default(cuid())
  name         String
  sku          String    @unique
  description  String?
  unit         String    @default("å€‹")
  quantity     Int       @default(0)
  minStock     Int       @default(0)
  maxStock     Int?
  location     String?
  expiryDate   DateTime?
  isActive     Boolean   @default(true)

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  transactions InventoryTxn[]

  @@index([sku])
  @@index([name])
  @@index([quantity, minStock])
}

model InventoryTxn {
  id            String   @id @default(cuid())
  type          String   // IN, OUT, ADJUST, EXPIRED
  quantity      Int      // positive for IN, negative for OUT
  note          String?

  itemId        String
  item          InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  performedById String
  performedBy   User     @relation(fields: [performedById], references: [id], onDelete: Restrict)

  createdAt     DateTime @default(now())

  @@index([itemId, createdAt])
  @@index([performedById, createdAt])
  @@index([type, createdAt])
}

model AuditLog {
  id         String   @id @default(cuid())
  action     String   // AUTH_LOGIN, HANDOVER_CREATE, INVENTORY_UPDATE, etc.
  targetId   String?
  targetType String?
  metadata   String?  // JSON string
  ip         String?
  userAgent  String?

  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Restrict)

  createdAt  DateTime @default(now())

  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@index([targetId, targetType])
}

model Notification {
  id        String   @id @default(cuid())
  type      String   // HANDOVER_ASSIGNED, INVENTORY_LOW, etc.
  title     String
  message   String
  isRead    Boolean  @default(false)
  metadata  String?  // JSON string

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId, isRead, createdAt])
  @@index([type, createdAt])
}
